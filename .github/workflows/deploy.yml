name: 前端自动部署 (Frontend)

on:
  push:
    # ⚠️ 注意：检查你的分支是 main 还是 master，一定要写对！
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v3

      - name: 安装 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: 打包构建
        run: |
          npm install
          npm run build
          # 打包完后，根目录下会生成一个 dist 文件夹

      - name: 上传文件到服务器
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # 以前端仓库根目录为起点，把 dist 文件夹传上去
          source: "dist/*"
          # 传到服务器的一个临时文件夹
          target: "/www/wwwroot/temp_dist/"
          strip_components: 1

      - name: 部署更新
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            echo "开始部署前端..."
            # ⚠️ 这里非常重要！必须是你宝塔面板里真实的【网站根目录】
            # 通常是 IP 命名的文件夹，或者你绑定的域名文件夹
            WEB_PATH="/www/wwwroot/47.111.7.146"

            # 1. 删除旧文件 (保留目录本身)
            rm -rf $WEB_PATH/*
            
            # 2. 把临时文件夹的新文件移动过去
            cp -r /www/wwwroot/temp_dist/* $WEB_PATH/
            
            # 3. 删除临时文件夹
            rm -rf /www/wwwroot/temp_dist
            
            echo "前端部署完成！"